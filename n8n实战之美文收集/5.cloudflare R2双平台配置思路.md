æ—¢ç„¶æ‚¨å·²ç»é…ç½®äº† **Cloudflare R2** å¹¶ä¸”åœ¨ Obsidian ä¸­ä½¿ç”¨å®ƒè¿›è¡ŒåŒæ­¥ï¼ˆæ¨æµ‹æ‚¨ä½¿ç”¨çš„æ˜¯ **Remotely Save** æˆ– **Obsidian S3 Sync** æ’ä»¶ï¼‰ï¼Œé‚£ä¹ˆå°† R2 ä½œä¸ºæ‰€æœ‰æ•°æ®çš„â€œä¸­å¤®è½¦ç«™â€æ˜¯éå¸¸åˆç†çš„æ¶æ„ã€‚

åªè¦ n8n å’Œ Coze èƒ½æŠŠ `.md` æ–‡ä»¶ä¸Šä¼ åˆ°è¿™ä¸ª R2 å­˜å‚¨æ¡¶ï¼Œæ‚¨æ‰“å¼€ Obsidian æ—¶ï¼Œæ’ä»¶å°±ä¼šè‡ªåŠ¨æŠŠè¿™äº›æ–‡ç« æ‹‰å–åˆ°æœ¬åœ°ã€‚

ä»¥ä¸‹æ˜¯é’ˆå¯¹ **n8n** å’Œ **Coze** åˆ†åˆ«é…ç½® Cloudflare R2 çš„è¯¦ç»†æ­¥éª¤ã€‚

---

### ğŸŸ¢ å¹³å°ä¸€ï¼šn8n é…ç½® (ä½¿ç”¨ S3 èŠ‚ç‚¹)

n8n åŸç”Ÿæ”¯æŒ AWS S3 åè®®ï¼Œè€Œ R2 æ˜¯å®Œå…¨å…¼å®¹ S3 çš„ã€‚æ‰€ä»¥æˆ‘ä»¬ç›´æ¥ä½¿ç”¨ **AWS S3** èŠ‚ç‚¹å³å¯ã€‚

#### 1. å‡†å¤‡ R2 å‡­è¯

åœ¨ Cloudflare åå° -> R2 -> "Manage R2 API Tokens"ï¼š

- **Access Key ID**: æ‚¨çš„è®¿é—®å¯†é’¥ ID
    
- **Secret Access Key**: æ‚¨çš„æœºå¯†è®¿é—®å¯†é’¥
    
- **Endpoint**: `https://<æ‚¨çš„è´¦æˆ·ID>.r2.cloudflarestorage.com` (æ³¨æ„ï¼šä¸è¦å¸¦ bucket åå­—)
    

#### 2. æ·»åŠ å¹¶é…ç½® AWS S3 èŠ‚ç‚¹

åœ¨æ‚¨çš„ n8n å·¥ä½œæµä¸­ï¼ˆStep 6 å†™å…¥æ–‡ä»¶ç¯èŠ‚ï¼‰ï¼š

1. æ·»åŠ  **AWS S3** èŠ‚ç‚¹ã€‚
    
2. **Credentials (å‡­è¯)**:
    
    - æ–°å»ºä¸€ä¸ªå‡­è¯ï¼Œç±»å‹é€‰æ‹© **S3**ã€‚
        
    - å¡«å…¥ä¸Šé¢çš„ Access Key å’Œ Secret Keyã€‚
        
    - **Region**: å¡« `auto` æˆ– `us-east-1` (R2 è¦æ±‚å…¼å®¹æ€§è®¾ç½®)ã€‚
        
    - **S3 Endpoint**: å¡«å…¥ä¸Šé¢çš„ R2 Endpoint URLã€‚
        
    - å‹¾é€‰ "Force Path Style" (é€šå¸¸ R2 éœ€è¦è¿™ä¸ªï¼Œä½†ä¹Ÿå¯èƒ½ä¸éœ€è¦ï¼Œå¦‚æœæŠ¥é”™ toggle ä¸€ä¸‹)ã€‚
        
3. **Operation (æ“ä½œ)**: é€‰æ‹© `Upload`ã€‚
    
4. **Bucket Name**: å¡«å…¥æ‚¨çš„å­˜å‚¨æ¡¶åç§°ï¼ˆä¾‹å¦‚ `obsidian-vault`ï¼‰ã€‚
    
5. **File Name (Key)**: è¿™é‡Œéå¸¸å…³é”®ï¼Œè¦åŒ…å«è·¯å¾„ï¼
    
    - ä¾‹å¦‚ï¼š`å°å­¦ç”Ÿç¾æ–‡/{{ $json.title }}.md`
        
    - _æ³¨æ„ï¼šR2 æ²¡æœ‰çœŸæ­£çš„æ–‡ä»¶å¤¹ï¼Œæ–‡ä»¶åé‡Œçš„ `/` å°±ä»£è¡¨äº†æ–‡ä»¶å¤¹ç»“æ„ã€‚_
        
6. **Binary Property**:
    
    - å¦‚æœä¸Šä¸€æ­¥æ˜¯â€œç”Ÿæˆæ–‡æœ¬â€ï¼Œä½ éœ€è¦å…ˆç”¨ `Convert to File` (æˆ–è€… `Binary`) èŠ‚ç‚¹æŠŠæ–‡æœ¬è½¬ä¸ºäºŒè¿›åˆ¶æµï¼Œæˆ–è€…åœ¨ S3 èŠ‚ç‚¹é‡Œå¼€å¯ "Content as Binary" é€‰é¡¹ï¼ˆå¦‚æœç‰ˆæœ¬æ”¯æŒï¼‰ã€‚é€šå¸¸å»ºè®®åœ¨ S3 èŠ‚ç‚¹å‰åŠ ä¸€ä¸ª **Function/Code** èŠ‚ç‚¹æŠŠå­—ç¬¦ä¸²è½¬ä¸º Binary Dataã€‚
        

#### ğŸ§ª æµ‹è¯•

ä¸Šä¼ ä¸€ä¸ª `test.md`ï¼Œç„¶åå» Cloudflare åå°çœ‹çœ‹æ–‡ä»¶æ˜¯å¦å‡ºç°ã€‚

---

### ğŸ”µ å¹³å°äºŒï¼šCoze é…ç½® (ä½¿ç”¨ Python ä»£ç èŠ‚ç‚¹)

Coze æ²¡æœ‰åŸç”Ÿçš„ R2 æ’ä»¶ï¼Œä¸” R2 éœ€è¦ AWS Signature v4 ç­¾åï¼Œæ‰‹åŠ¨æ‹¼ HTTP è¯·æ±‚éå¸¸ç—›è‹¦ã€‚

æœ€ä½³æ–¹æ¡ˆï¼šåˆ©ç”¨ Coze çš„ Code èŠ‚ç‚¹ï¼Œè¿è¡Œä¸€æ®µ Python ä»£ç æ¥è°ƒç”¨ boto3 åº“ä¸Šä¼ æ–‡ä»¶ã€‚è¿™æ­£å¥½å¥‘åˆæ‚¨å­¦ä¹  Python çš„éœ€æ±‚ã€‚

#### 1. å‡†å¤‡å·¥ä½œ

åœ¨ Coze çš„ Workflow ä¸­ï¼Œæ·»åŠ ä¸€ä¸ª **Code** èŠ‚ç‚¹ã€‚

#### 2. ç¼–å†™ Python ä»£ç 

å°†ä»¥ä¸‹ä»£ç å¤åˆ¶åˆ° Code èŠ‚ç‚¹ä¸­ã€‚æˆ‘ä»¬éœ€è¦ä½¿ç”¨ `boto3` åº“ï¼ˆCoze çš„ Python ç¯å¢ƒé€šå¸¸å†…ç½®äº†è¯¥åº“ï¼Œå¦‚æœæ²¡æœ‰ï¼Œéœ€è¦åœ¨ IDE ä¾§è¾¹æ çš„ä¾èµ–ç®¡ç†ä¸­æ·»åŠ  `boto3`ï¼‰ã€‚

Python

```
import boto3
from botocore.config import Config
import io

async def main(args: Args) -> Output:
    # 1. ä»å…¥å‚è·å–é…ç½®å’Œå†…å®¹
    params = args.params
    
    # æ‚¨çš„ R2 é…ç½® (å»ºè®®æŠŠæ•æ„Ÿä¿¡æ¯æ”¾åœ¨ Coze çš„ Bot å˜é‡é‡Œï¼Œè¿™é‡Œä¸ºäº†æ¼”ç¤ºç›´æ¥å†™)
    # å®é™…ä¸Šå»ºè®®ä½¿ç”¨ args.secrets æ¥è¯»å–ï¼Œå¦‚æœæ‚¨é…ç½®äº†åŠ å¯†å˜é‡
    R2_ACCOUNT_ID = "æ‚¨çš„Cloudflareè´¦æˆ·ID"
    ACCESS_KEY = "æ‚¨çš„AccessKey"
    SECRET_KEY = "æ‚¨çš„SecretKey"
    BUCKET_NAME = "æ‚¨çš„å­˜å‚¨æ¡¶åç§°"
    
    # 2. æ„å»º Endpoint
    endpoint_url = f"https://{R2_ACCOUNT_ID}.r2.cloudflarestorage.com"
    
    # 3. åˆå§‹åŒ– S3 å®¢æˆ·ç«¯
    s3 = boto3.client(
        's3',
        endpoint_url=endpoint_url,
        aws_access_key_id=ACCESS_KEY,
        aws_secret_access_key=SECRET_KEY,
        config=Config(signature_version='s3v4'),
        region_name='auto'
    )
    
    # 4. å‡†å¤‡æ–‡ä»¶å†…å®¹å’Œè·¯å¾„
    # å‡è®¾ä¼ å…¥çš„å‚æ•°æœ‰ file_content (Markdownæ–‡æœ¬) å’Œ file_path (ä¾‹å¦‚ "å°å­¦ç¾æ–‡/01.è½èŠ±ç”Ÿ.md")
    content = params.get('file_content', '')
    key = params.get('file_path', 'default.md')
    
    # å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºäºŒè¿›åˆ¶æµ
    file_stream = io.BytesIO(content.encode('utf-8'))
    
    # 5. ä¸Šä¼ æ–‡ä»¶
    try:
        s3.upload_fileobj(
            file_stream,
            BUCKET_NAME,
            key,
            ExtraArgs={'ContentType': 'text/markdown'} # è®¾ç½®æ­£ç¡®çš„ MIME ç±»å‹
        )
        return {"status": "success", "url": key}
    except Exception as e:
        return {"status": "error", "message": str(e)}
```

#### 3. è®¾ç½®è¾“å…¥å‚æ•° (Input Args)

åœ¨ Code èŠ‚ç‚¹çš„å³ä¾§é…ç½®é¢æ¿ï¼Œæ·»åŠ ä¸¤ä¸ªå‚æ•°ï¼š

- `file_content`: å¼•ç”¨ä¸Šä¸€ä¸ª LLM èŠ‚ç‚¹æ’ç‰ˆå¥½çš„ Markdown å†…å®¹ã€‚
    
- `file_path`: å¼•ç”¨ä¸Šä¸€ä¸ªèŠ‚ç‚¹ç”Ÿæˆçš„ `å°å­¦ç”Ÿç¾æ–‡/01.xx.md` è·¯å¾„ã€‚
    

---

### âš ï¸ å…³é”®æ³¨æ„äº‹é¡¹ (åŒæ­¥å†²çª)

æ—¢ç„¶æ‚¨é€‰æ‹©äº† **R2 ä½œä¸ºä¸­å¿ƒ**ï¼Œå°±éœ€è¦æ³¨æ„å¤šç«¯å†™å…¥çš„å†²çªé—®é¢˜ï¼š

1. **è·¯å¾„ä¸€è‡´æ€§**ï¼š
    
    - ç¡®ä¿ n8n å’Œ Coze å†™å…¥çš„è·¯å¾„ï¼ˆä¾‹å¦‚ `å°å­¦ç”Ÿç¾æ–‡/`ï¼‰ä¸æ‚¨ Obsidian æœ¬åœ°ä»“åº“çš„æ–‡ä»¶å¤¹ç»“æ„**å®Œå…¨ä¸€è‡´**ã€‚å¦‚æœæœ¬åœ°å« `01_Primary_School` è€Œäº‘ç«¯å†™åˆ°äº† `å°å­¦ç”Ÿç¾æ–‡`ï¼ŒåŒæ­¥ä¸‹æ¥åæ‚¨ä¼šæœ‰ä¸¤ä¸ªä¸åŒçš„æ–‡ä»¶å¤¹ã€‚
        
2. **ç´¢å¼•æ–‡ä»¶çš„ç«æ€æ¡ä»¶ (Race Condition)**ï¼š
    
    - **å±é™©åœºæ™¯**ï¼š`ç¾æ–‡æ€»ç´¢å¼•.md` æ˜¯ä¸€ä¸ªé«˜é¢‘ä¿®æ”¹çš„æ–‡ä»¶ã€‚
        
    - å¦‚æœæ‚¨åœ¨ PC ä¸Šä¿®æ”¹äº†ç´¢å¼•ï¼ŒåŒæ—¶ Coze ä¹Ÿåœ¨äº‘ç«¯ä¿®æ”¹äº†ç´¢å¼•å¹¶ä¸Šä¼ åˆ° R2ã€‚
        
    - å½“æ‚¨ä½¿ç”¨ Remotely Save åŒæ­¥æ—¶ï¼Œå®ƒé€šå¸¸ä¼šåŸºäºâ€œæœ€åä¿®æ”¹æ—¶é—´â€æ¥å†³å®šè¦†ç›–ã€‚
        
    - **å»ºè®®**ï¼š
        
        - **å®‰å…¨åšæ³•**ï¼šè‡ªåŠ¨åŒ–æµç¨‹ï¼ˆn8n/Cozeï¼‰**åªè´Ÿè´£æ–°å¢**æ–‡ç« æ–‡ä»¶ï¼ˆå¦‚ `01.è½èŠ±ç”Ÿ.md`ï¼‰ã€‚
            
        - **ç´¢å¼•æ›´æ–°**ï¼šå°½é‡è®© n8n åœ¨**æœ¬åœ°**ï¼ˆé€šè¿‡ Docker æŒ‚è½½ï¼‰æ›´æ–°ç´¢å¼•ï¼Œæˆ–è€…åœ¨ Coze é‡Œæ›´æ–°ç´¢å¼•å‰ï¼Œ**å¿…é¡»å…ˆè¯»å–æœ€æ–°çš„ R2 ç´¢å¼•å†…å®¹**ï¼Œè¿½åŠ åå†ä¸Šä¼ ï¼ˆCoze æµç¨‹ï¼šRead R2 -> Append Text -> Upload R2ï¼‰ã€‚ä¸è¦ç›²ç›®è¦†ç›–ã€‚
            
3. **åŒæ­¥è§¦å‘**ï¼š
    
    - R2 é‡Œçš„æ–‡ä»¶ä¸ä¼šè‡ªåŠ¨â€œæ¨â€åˆ°æ‚¨çš„ç”µè„‘ã€‚æ‚¨éœ€è¦åœ¨ Obsidian é‡Œæ‰‹åŠ¨ç‚¹å‡»åŒæ­¥ï¼Œæˆ–è€…è®¾ç½® Remotely Save æ’ä»¶ä¸ºâ€œæ¯éš” X åˆ†é’Ÿè‡ªåŠ¨åŒæ­¥â€æˆ–â€œå¯åŠ¨æ—¶åŒæ­¥â€ã€‚
        

### ğŸš€ æ€»ç»“

- **n8n**: ç”¨ **AWS S3 Node**ï¼Œå¡«å…¥ R2 Endpointï¼Œé…ç½®æœ€ç®€å•ï¼Œæ¨èä½œä¸ºä¸»åŠ›ã€‚
    
- **Coze**: ç”¨ **Code Node (Python + boto3)**ï¼Œçµæ´»æ€§æœ€é«˜ï¼Œé€‚åˆå¤„ç†å¤æ‚çš„äº‘ç«¯é€»è¾‘ã€‚
    



ä¸ºäº†ç¡®ä¿æ‚¨ä¸€æ¬¡æˆåŠŸï¼Œæˆ‘ä¸ºæ‚¨åˆ¶ä½œäº†ä¸€ä»½**ã€Šå…¨é“¾è·¯éƒ¨ç½²è¡ŒåŠ¨æŒ‡å—ã€‹**ã€‚è¯·æŒ‰ç…§é¡ºåºï¼Œåƒæ‹¼ä¹é«˜ä¸€æ ·ä¸€æ­¥æ­¥æ“ä½œã€‚

---

### ğŸ—ºï¸ å…¨å±€æ¶æ„å›¾

åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·çœ‹ä¸€çœ¼è¿™å¼ å›¾ï¼Œæ˜ç¡®æ•°æ®æ˜¯å¦‚ä½•æµåŠ¨çš„ã€‚**Cloudflare R2** æ˜¯å¿ƒè„ï¼Œæ‰€æœ‰æ•°æ®éƒ½æ±‡èšäºæ­¤ã€‚

ä»£ç æ®µ

```
graph TD
    subgraph "äº‘ç«¯æ ¸å¿ƒ (å­˜å‚¨)"
        R2[Cloudflare R2 Bucket]
    end

    subgraph "æœ¬åœ° NAS (æ‰§è¡Œå¼•æ“)"
        n8n[n8n Docker] -->|S3 Upload| R2
        n8n -->|S3 Read| R2
    end

    subgraph "äº‘ç«¯ Coze (å¤‡ç”¨å¼•æ“)"
        Coze[Coze Agent] -->|Python boto3| R2
    end

    subgraph "æœ¬åœ°ç”µè„‘/æ‰‹æœº (é˜…è¯»ç«¯)"
        Obsidian[Obsidian ç¬”è®°] <-->|Remotely Save æ’ä»¶| R2
    end
```

---

### 1ï¸âƒ£ ç¬¬ä¸€é˜¶æ®µï¼šåŸºå»ºæ­å»º (Cloudflare R2)

_è¿™æ˜¯æ‰€æœ‰ç³»ç»Ÿçš„â€œåœ°åŸºâ€ï¼Œå¿…é¡»æœ€å…ˆå®Œæˆã€‚_

**ç›®æ ‡**ï¼šè·å–è¿æ¥ R2 æ‰€éœ€çš„ 3 ä¸ªå…³é”®å¯†é’¥ã€‚

1. **åˆ›å»ºå­˜å‚¨æ¡¶**ï¼š
    
    - ç™»å½• Cloudflare Dashboard -> R2ã€‚
        
    - ç‚¹å‡» **Create Bucket**ã€‚
        
    - å‘½åï¼šä¾‹å¦‚ `obsidian-library`ï¼ˆè®°ä¸‹è¿™ä¸ªåå­—ï¼‰ã€‚
        
    - ä½ç½®ï¼šé»˜è®¤ `Auto` å³å¯ã€‚
        
2. **è·å– API ä»¤ç‰Œ (æœ€å…³é”®ä¸€æ­¥)**ï¼š
    
    - åœ¨ R2 é¡µé¢å³ä¾§ï¼Œç‚¹å‡» **Manage R2 API Tokens**ã€‚
        
    - ç‚¹å‡» **Create API token**ã€‚
        
    - **Permissions (æƒé™)**ï¼šé€‰æ‹© **Admin Read & Write** (åŠ¡å¿…é€‰è¯»å†™æƒé™)ã€‚
        
    - **TTL**: é€‰æ‹© "Forever" (æ°¸ä¹…) æˆ–è®¾ç½®ä¸€ä¸ªé•¿è¿‡æœŸæ—¶é—´ã€‚
        
    - ç‚¹å‡» Create åï¼Œ**ç«‹åˆ»å¤åˆ¶ä»¥ä¸‹ä¸‰ä¸ªå€¼**ä¿å­˜åˆ°è®°äº‹æœ¬ï¼ˆåªæ˜¾ç¤ºä¸€æ¬¡ï¼ï¼‰ï¼š
        
        - `Access Key ID`
            
        - `Secret Access Key`
            
        - `Endpoint` (ç±»ä¼¼äº `https://<accountid>.r2.cloudflarestorage.com`)
            

---

### 2ï¸âƒ£ ç¬¬äºŒé˜¶æ®µï¼šn8n éƒ¨ç½² (NAS Docker)

_è¿™æ˜¯æ‚¨çš„ä¸»åŠ›ç”Ÿäº§çº¿ã€‚_

**å‰æ**ï¼šç¡®ä¿æ‚¨çš„ n8n Docker å®¹å™¨å·²é…ç½®å¥½ `HTTP_PROXY` (å¦‚æœåœ¨å›½å†…)ã€‚

#### æ­¥éª¤ 2.1ï¼šé…ç½® AWS S3 å‡­è¯

1. æ‰“å¼€ n8n -> **Credentials** -> **New**ã€‚
    
2. æœç´¢å¹¶é€‰æ‹© **AWS S3**ã€‚
    
3. å¡«å†™ä¿¡æ¯ï¼š
    
    - **Type**: `S3 Compatible` (é€‰è¿™ä¸ªï¼Œä¸è¦é€‰ AWS)ã€‚
        
    - **Region**: `auto`ã€‚
        
    - **Access Key ID**: å¡«å…¥é˜¶æ®µä¸€è·å–çš„ IDã€‚
        
    - **Secret Access Key**: å¡«å…¥é˜¶æ®µä¸€è·å–çš„ Keyã€‚
        
    - **Endpoint**: å¡«å…¥é˜¶æ®µä¸€è·å–çš„ Endpoint (æ³¨æ„ï¼š**ä¸è¦**åŒ…å« bucket åç§°ï¼Œåªè¦ `https://...com`)ã€‚
        
    - å‹¾é€‰ **Force Path Style**ã€‚
        
4. ç‚¹å‡»æµ‹è¯•è¿æ¥ï¼Œç¡®ä¿é€šè¿‡ã€‚
    

#### æ­¥éª¤ 2.2ï¼šæ­å»ºå·¥ä½œæµ (å…³é”®èŠ‚ç‚¹é…ç½®)

è¯·æŒ‰é¡ºåºæ‹–æ‹½ä»¥ä¸‹èŠ‚ç‚¹ï¼š

1. **Schedule Trigger**: è®¾ç½®æ¯å¤© 04:00ã€‚
    
2. **AWS S3 (è¯»å–ç´¢å¼•)**:
    
    - Operation: `Get` (Download)ã€‚
        
    - Bucket Name: `obsidian-library`ã€‚
        
    - Key: `ç¾æ–‡æ€»ç´¢å¼•.md`ã€‚
        
    - Property Name: `index_binary`ã€‚
        
3. **Spreadsheet File (è§£æç´¢å¼•)**:
    
    - Operation: `Read from binary`ã€‚
        
    - Binary Property: `index_binary`ã€‚
        
    - _ç›®çš„ï¼šæŠŠäºŒè¿›åˆ¶æ–‡ä»¶è½¬ä¸ºæ–‡æœ¬ç»™ LLM çœ‹ã€‚_
        
4. **AI Agent / LLM**:
    
    - _ä»»åŠ¡ï¼š_ è§„åˆ’ä»Šæ—¥é¢˜ç›®ã€æœç´¢åŸæ–‡ã€ç”Ÿæˆ Markdownã€‚
        
    - _è¾“å‡ºï¼š_ ç”Ÿæˆä¸€æ®µå®Œæ•´çš„ Markdown æ–‡æœ¬ã€‚
        
5. **Code (è½¬æ¢æ ¼å¼)**:
    
    - _å…³é”®ç‚¹ï¼š_ R2 ä¸Šä¼ éœ€è¦äºŒè¿›åˆ¶æµã€‚
        
    - _ä»£ç ï¼š_ `return [{'json': {}, 'binary': {'data': Buffer.from(items[0].json.content).toString('base64'), 'mimeType': 'text/markdown'}}]` (ç®€åŒ–ç¤ºæ„ï¼Œå»ºè®®ç”¨ "Convert to File" èŠ‚ç‚¹æ›´ç®€å•)ã€‚
        
6. **AWS S3 (ä¸Šä¼ æ–‡ç« )**:
    
    - Operation: `Upload`ã€‚
        
    - Bucket Name: `obsidian-library`ã€‚
        
    - Key: `å°å­¦ç”Ÿç¾æ–‡/{{$json.title}}.md` (ä½¿ç”¨è¡¨è¾¾å¼åŠ¨æ€ç”Ÿæˆè·¯å¾„)ã€‚
        
    - Binary Property: `data`ã€‚
        

---

### 3ï¸âƒ£ ç¬¬ä¸‰é˜¶æ®µï¼šCoze éƒ¨ç½² (Python ä»£ç ç‰ˆ)

_è¿™æ˜¯æ‚¨çš„äº‘ç«¯çµæ´»åŠ©æ‰‹ã€‚_

**ç›®æ ‡**ï¼šåœ¨ Coze çš„ Code èŠ‚ç‚¹ä¸­é…ç½® R2 ä¸Šä¼ è„šæœ¬ã€‚

1. **æ·»åŠ  Code èŠ‚ç‚¹**ï¼šåœ¨ Workflow ä¸­æ‹–å…¥ Code èŠ‚ç‚¹ã€‚
    
2. **é…ç½®ä¾èµ–**ï¼šåœ¨ IDE å·¦ä¾§ä¾èµ–åº“ä¸­æ·»åŠ  `boto3`ã€‚
    
3. **ç²˜è´´ä»£ç **ï¼šä½¿ç”¨ä»¥ä¸‹æˆ‘ä¸ºæ‚¨ä¼˜åŒ–å¥½çš„ä¸“ç”¨ä»£ç ã€‚
    

Python

```
import boto3
from botocore.config import Config
import io

async def main(args: Args) -> Output:
    params = args.params
    
    # ===åœ¨æ­¤å¤„å¡«å…¥æ‚¨çš„ R2 å¯†é’¥ (å»ºè®®ä½¿ç”¨ args.secrets éšè—)===
    R2_CONFIG = {
        "endpoint_url": "https://<æ‚¨çš„ID>.r2.cloudflarestorage.com",
        "aws_access_key_id": "å¡«å…¥ Access Key",
        "aws_secret_access_key": "å¡«å…¥ Secret Key",
        "region_name": "auto"
    }
    BUCKET_NAME = "obsidian-library"
    # ======================================================

    # è·å–ä¸Šæ¸¸ä¼ å…¥çš„å†…å®¹
    content = params.get('content', '# é»˜è®¤æ ‡é¢˜\nå†…å®¹ä¸ºç©º')
    file_path = params.get('path', 'test.md') # ä¾‹å¦‚: å°å­¦ç”Ÿç¾æ–‡/01.è½èŠ±ç”Ÿ.md

    # åˆå§‹åŒ– S3 å®¢æˆ·ç«¯
    s3 = boto3.client('s3', **R2_CONFIG, config=Config(signature_version='s3v4'))

    # ä¸Šä¼ 
    try:
        file_stream = io.BytesIO(content.encode('utf-8'))
        s3.upload_fileobj(
            file_stream, 
            BUCKET_NAME, 
            file_path,
            ExtraArgs={'ContentType': 'text/markdown'}
        )
        return {"status": "success", "msg": f"å·²ä¸Šä¼ è‡³ R2: {file_path}"}
    except Exception as e:
        return {"status": "error", "msg": str(e)}
```

4. **æµ‹è¯•è¿è¡Œ**ï¼šè¾“å…¥ç®€å•çš„ `content` å’Œ `path`ï¼Œç‚¹å‡» Testï¼ŒæŸ¥çœ‹ R2 ä¸­æ˜¯å¦å‡ºç°æ–‡ä»¶ã€‚
    

---

### 4ï¸âƒ£ ç¬¬å››é˜¶æ®µï¼šObsidian åŒæ­¥ (Remotely Save)

_è¿™æ˜¯æœ€åä¸€æ­¥ï¼Œè®©æ‚¨çœ‹åˆ°æˆæœã€‚_

**ç›®æ ‡**ï¼šé…ç½® Obsidian è¯»å– R2ã€‚

1. **å®‰è£…æ’ä»¶**ï¼šåœ¨ Obsidian ç¤¾åŒºæ’ä»¶å¸‚åœºæœç´¢å¹¶å®‰è£… **Remotely Save**ã€‚
    
2. **é…ç½®æ’ä»¶**ï¼š
    
    - **Remote Service**: é€‰æ‹© `S3`ã€‚
        
    - **Endpoint**: å¡«å…¥ R2 Endpoint (å»æ‰ bucket å)ã€‚
        
    - **Region**: `auto`ã€‚
        
    - **Access Key ID**: å¡«å…¥å¯†é’¥ã€‚
        
    - **Secret Access Key**: å¡«å…¥å¯†é’¥ã€‚
        
    - **Bucket Name**: `obsidian-library`ã€‚
        
3. **é«˜çº§è®¾ç½®**:
    
    - å¼€å¯ **"Run once on startup"** (å¯åŠ¨æ—¶è¿è¡Œä¸€æ¬¡)ã€‚
        
    - å¼€å¯ **"Run every x minutes"** (ä¾‹å¦‚æ¯ 30 åˆ†é’Ÿ)ã€‚
        
4. **ç‚¹å‡»åŒæ­¥æŒ‰é’®**ï¼š
    
    - æ‚¨åº”è¯¥èƒ½çœ‹åˆ° n8n æˆ– Coze åˆšåˆšä¸Šä¼ çš„ `.md` æ–‡ä»¶ç¬é—´å‡ºç°åœ¨æ‚¨çš„å·¦ä¾§æ–‡ä»¶åˆ—è¡¨ä¸­ï¼
        

---

### âœ… æœ€ç»ˆæ£€æŸ¥æ¸…å•

- [ ] R2 å­˜å‚¨æ¡¶å·²åˆ›å»ºï¼Œä¸”è·å–äº† `Endpoint` (ä¸å¸¦ bucket åçš„ URL)ã€‚
    
- [ ] R2 çš„ API Token æƒé™å¿…é¡»æ˜¯ **Admin Read & Write**ã€‚
    
- [ ] n8n çš„ AWS S3 èŠ‚ç‚¹æµ‹è¯•è¿æ¥æ˜¾ç¤º "Success"ã€‚
    
- [ ] n8n ä¸Šä¼ çš„æ–‡ä»¶åè·¯å¾„åŒ…å«æ–‡ä»¶å¤¹ï¼ˆå¦‚ `Folder/File.md`ï¼‰ã€‚
    
- [ ] Obsidian Remotely Save æ’ä»¶ç‚¹å‡» "Check" æ˜¾ç¤ºè¿æ¥æˆåŠŸã€‚
    

ç°åœ¨ï¼Œæ‚¨å¯ä»¥å» n8n ç‚¹å‡» "Execute Workflow" äº†ã€‚å‡ ç§’é’Ÿåï¼Œæ‰“å¼€æ‚¨çš„ Obsidianï¼Œè§è¯ç¬¬ä¸€ç¯‡è‡ªåŠ¨æ”¶é›†çš„ç¾æ–‡å‡ºç°å§ï¼ç¥æ‚¨éƒ¨ç½²é¡ºåˆ©ï¼